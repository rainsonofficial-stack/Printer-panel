<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Magic Live</title>
<style>
  :root{
    --bg:#000; --muted:#ccc;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,Arial; -webkit-text-size-adjust:100%;}
  /* Password (unlock) screen */
  #passwordScreen{
    display:flex;
    align-items:flex-start;
    justify-content:center;
    height:100vh;
    padding-top:14vh; /* slightly above center */
    box-sizing:border-box;
    text-align:center;
    background: radial-gradient(circle at center,#0b0b0b,#000);
  }
  .pwCard{
    width:92%;
    max-width:420px;
    background: rgba(255,255,255,0.03);
    padding:24px;
    border-radius:16px;
    -webkit-backdrop-filter: blur(6px);
    backdrop-filter: blur(6px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  }
  .hat{ font-size:48px; margin-bottom:8px; }
  h1{ margin:0; font-size:1.35rem; letter-spacing:0.6px; margin-bottom:10px; }
  input[type="password"]{
    width:100%;
    padding:14px;
    font-size:16px;
    border-radius:12px;
    border:0;
    outline: none;
    text-align:center;
    background: rgba(255,255,255,0.04);
    color:#fff;
    margin-top:6px;
  }
  button#enterBtn{
    margin-top:18px;
    padding:12px 20px;
    border-radius:12px;
    border:0;
    background: linear-gradient(90deg,#ff0080,#7928ca);
    color:#fff;
    font-size:16px;
    cursor:pointer;
    width:100%;
  }
  button#enterBtn:active{ transform:scale(0.995); }

  /* Main content - vertical stacked images */
  #main{
    display:none;
    width:100%;
    height:100vh;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    background: #000;
  }
  .slide{
    width:100%;
    display:block;
  }
  .slide img{
    width:100%;
    height:auto;              /* preserve aspect ratio */
    display:block;
    object-fit:cover;
  }

  /* Debug hint (hidden by default) - not visible to spectator */
  .debugNote{ position:fixed; left:8px; bottom:8px; color:rgba(255,255,255,0.25); font-size:12px; z-index:9999; }

  /* Ensure no accidental selection during touch */
  img, body { -webkit-user-select:none; user-select:none; -webkit-tap-highlight-color: rgba(0,0,0,0); }
</style>
</head>
<body>

  <!-- PASSWORD / UNLOCK -->
  <div id="passwordScreen" aria-hidden="false">
    <div class="pwCard" role="dialog" aria-label="Enter witness magic">
      <div class="hat" aria-hidden="true">ðŸŽ©</div>
      <h1>Witness Live Magic</h1>
      <input id="magicInput" type="password" inputmode="numeric" placeholder="Say the Magic Word" aria-label="Say the Magic Word" />
      <button id="enterBtn" aria-label="Enter">Enter</button>
    </div>
  </div>

  <!-- MAIN: 6 vertical full-width images (random placeholders) -->
  <div id="main" aria-hidden="true">
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=101" alt=""></div>
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=102" alt=""></div>
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=103" alt=""></div>
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=104" alt=""></div>
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=105" alt=""></div>
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=106" alt=""></div>
  </div>

  <div class="debugNote" style="display:none">debug: taps shown in console</div>

<script>
/* CONFIG */
const PASSWORD = "MagicRain";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxJ6hgXpP8VU6yZm9nGzR-ZRoVF4qKd0XtWthzTmMNOkQYhFw_wf97It_qWYkJeLMrG/exec";
const MAX_INPUTS = 3;        // record only first 3 inputs

/* STATE */
const passwordScreen = document.getElementById('passwordScreen');
const main = document.getElementById('main');
const magicInput = document.getElementById('magicInput');
const enterBtn = document.getElementById('enterBtn');

let recorded = [];           // collected digits (strings)
let recordingEnabled = false;

/* Unlock handler (exact wording preserved on UI) */
enterBtn.addEventListener('click', () => {
  if (magicInput.value === PASSWORD) {
    // show main page
    passwordScreen.style.display = 'none';
    main.style.display = 'block';
    main.setAttribute('aria-hidden','false');
    recordingEnabled = true;
    // ensure initial scroll top so images stack from top
    setTimeout(()=> { main.scrollTop = 0; }, 60);
  } else {
    // polite message but keep wording minimal
    magicInput.value = '';
    magicInput.placeholder = 'Try again';
    setTimeout(()=> magicInput.placeholder = 'Say the Magic Word', 900);
  }
});

/* Touch handling:
   - We detect the first touch point of each swipe (touchstart).
   - Map clientX/clientY to a 3x3 grid cell (1..9), clamped to 0..2 to avoid -1.
   - We do NOT preventDefault so scrolling still works normally.
   - Only the first 3 recorded inputs are kept.
*/
function mapTouchToDigit(x, y) {
  const w = window.innerWidth || document.documentElement.clientWidth;
  const h = window.innerHeight || document.documentElement.clientHeight;
  // compute column and row with clamping
  const col = Math.min(2, Math.max(0, Math.floor((x / w) * 3)));
  const row = Math.min(2, Math.max(0, Math.floor((y / h) * 3)));
  const digit = row * 3 + col + 1; // 1..9
  return digit;
}

/* Listen on main container so vertical scrolling works as normal */
main.addEventListener('touchstart', (ev) => {
  if (!recordingEnabled) return;
  if (recorded.length >= MAX_INPUTS) return;

  const t = ev.touches[0];
  if (!t) return;

  const x = t.clientX;
  const y = t.clientY;

  const digit = mapTouchToDigit(x, y);
  recorded.push(String(digit));
  // debug in console only; no visible feedback
  console.log('Recorded digit', recorded.length, 'â†’', digit, 'code now:', recorded.join(''));

  if (recorded.length === MAX_INPUTS) {
    // send code and lock further recording
    recordingEnabled = false;
    sendCode(recorded.join(''));
  }
}, { passive: true }); // passive: don't block scrolling

/* Send the code to your Apps Script
   - Use GET fetch (no-cors) for reliability; fallback to image ping on error.
*/
function sendCode(code) {
  const url = SCRIPT_URL + '?user=pots&code=' + encodeURIComponent(code) + '&_=' + Date.now();
  // Try fetch GET; many Apps Script endpoints accept GET.
  fetch(url, { method: 'GET', mode: 'no-cors' })
    .then(() => {
      console.log('Code sent (fetch, no-cors):', code);
    })
    .catch((err) => {
      console.warn('Fetch failed, using image fallback:', err);
      const img = new Image();
      img.src = url;
      // silent fallback
    });
}

/* Safety: if user rotates screen, grid math still valid (uses innerWidth/innerHeight) */

/* Start the page on password screen */
passwordScreen.style.display = 'flex';
main.style.display = 'none';
</script>
</body>
</html>
