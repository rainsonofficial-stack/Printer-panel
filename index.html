<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Magic Live</title>
<style>
  :root{ --bg:#000; --muted:#999; }
  html,body{ height:100%; margin:0; background:var(--bg); color:#fff; font-family:Inter,system-ui,Arial; -webkit-text-size-adjust:100%; }
  /* Password screen: slightly above top (not centered) */
  #passwordScreen {
    position:fixed; inset:0;
    display:flex; align-items:flex-start; justify-content:center;
    padding-top:7vh; /* slightly near top */
    box-sizing:border-box;
    background: radial-gradient(circle at center,#030303,#000);
    z-index:50;
  }
  .pwCard {
    width:92%; max-width:420px;
    background: rgba(255,255,255,0.02);
    padding:22px; border-radius:14px;
    text-align:center;
    -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
  }
  .hat { font-size:48px; margin-bottom:8px }
  h1 { margin:0 0 6px; font-size:1.25rem; }
  input#magicInput {
    width:100%; padding:14px; font-size:16px; border-radius:10px; border:0;
    background:rgba(255,255,255,0.03); color:#fff; text-align:center;
    margin-top:8px; outline:none;
  }
  button#enterBtn {
    margin-top:14px; width:100%; padding:12px; border-radius:10px; border:0;
    background: linear-gradient(90deg,#ff0080,#7928ca); color:#fff; font-weight:600;
    cursor:pointer;
  }

  /* Main content (images) - scrollable area */
  #main {
    position:fixed; inset:0; overflow:hidden; display:none; background:#000;
  }
  #scroller {
    width:100%; height:100%; overflow-y:auto; -webkit-overflow-scrolling:touch;
    scroll-behavior:auto;
    -ms-overflow-style: none; scrollbar-width: none;
  }
  #scroller::-webkit-scrollbar{ display:none }
  .slide { width:100%; height:auto; display:block; }
  .slide img { width:100%; height:auto; display:block; object-fit:cover; -webkit-user-drag:none; }

  /* invisible overlay hint (not visible; retained for possible future toggles) */
  #overlay { position:fixed; inset:0; pointer-events:none; z-index:40; }

  /* small unobtrusive status (hidden by default) */
  #status { position:fixed; left:8px; bottom:8px; font-size:12px; color:rgba(255,255,255,0.12); pointer-events:none; z-index:60; }
</style>
</head>
<body>

<!-- PASSWORD (near top) -->
<div id="passwordScreen" aria-hidden="false">
  <div class="pwCard" role="dialog" aria-label="Magic access">
    <div class="hat" aria-hidden="true">ðŸŽ©</div>
    <h1>Witness Live Magic</h1>
    <input id="magicInput" type="password" inputmode="text" placeholder="Say the Magic Word" aria-label="Say the Magic Word" />
    <button id="enterBtn">Enter</button>
  </div>
</div>

<!-- MAIN images + scroller -->
<div id="main" aria-hidden="true">
  <div id="scroller" tabindex="0" aria-label="Gallery">
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=201" alt=""></div>
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=202" alt=""></div>
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=203" alt=""></div>
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=204" alt=""></div>
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=205" alt=""></div>
    <div class="slide"><img src="https://picsum.photos/1080/1920?random=206" alt=""></div>
  </div>
  <div id="overlay" aria-hidden="true"></div>
</div>

<div id="status" aria-hidden="true"></div>

<script>
/* CONFIG */
const PASSWORD = "MagicRain";
const MAX_INPUTS = 3;
// Use the working exec URL you provided
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzu7YDVtTt8uzCjYj5lWTucjm2kNkF8IRfXHNzq_wmKEeiXp2P7kNIfhgqSLcjnPQLK/exec";

/* STATE */
const passwordScreen = document.getElementById('passwordScreen');
const main = document.getElementById('main');
const scroller = document.getElementById('scroller');
const magicInput = document.getElementById('magicInput');
const enterBtn = document.getElementById('enterBtn');
const status = document.getElementById('status');

let recorded = [];            // collected digits (strings)
let enabled = false;          // recording enabled after unlock
let touchStartPoint = null;   // keep first touch start of current gesture

/* Unlock */
enterBtn.addEventListener('click', () => {
  const val = magicInput.value || '';
  if (val === PASSWORD) {
    // show main scroll area
    passwordScreen.style.display = 'none';
    main.style.display = 'block';
    main.setAttribute('aria-hidden','false');
    enabled = true;
    // allow the scroller to take scroll gestures
    scroller.scrollTop = 0;
    // ensure page-level scrolling disabled so scroller controls only
    document.body.style.overflow = 'hidden';
    status.textContent = 'unlocked';
  } else {
    magicInput.value = '';
    magicInput.placeholder = 'Try again';
    setTimeout(()=> magicInput.placeholder = 'Say the Magic Word', 900);
  }
});

/* Map coordinates to 3x3 cell robustly and clamp to avoid -1 */
function coordsToDigit(x, y) {
  const w = window.innerWidth || document.documentElement.clientWidth;
  const h = window.innerHeight || document.documentElement.clientHeight;
  let col = Math.floor((x / w) * 3);
  let row = Math.floor((y / h) * 3);
  if (!isFinite(col) || !isFinite(row)) return null;
  col = Math.min(2, Math.max(0, col));
  row = Math.min(2, Math.max(0, row));
  return row * 3 + col + 1; // 1..9
}

/* New: reliable GET ping sender (image) */
function sendCodeToScript_viaGET(code) {
  // Use an image ping so browsers always send the GET without CORS trouble
  const sep = SCRIPT_URL.indexOf('?') === -1 ? '?' : '&';
  const url = SCRIPT_URL + sep + 'user=pots&code=' + encodeURIComponent(code) + '&_=' + Date.now();
  const img = new Image();
  img.onload = () => { status.textContent = 'code sent'; };
  img.onerror = () => { status.textContent = 'code ping failed'; };
  img.src = url;
  // also try navigator.sendBeacon as a best-effort background send (not supported everywhere)
  if (navigator.sendBeacon) {
    try {
      const beaconUrl = SCRIPT_URL + '?user=pots&code=' + encodeURIComponent(code);
      navigator.sendBeacon(beaconUrl);
    } catch (e) { /* ignore */ }
  }
}

/* Touch handling â€” attach to scroller so scrolling still works normally.
   We capture touchstart coordinates (first touch point of a gesture).
   On touchend we register the digit based on the earlier start point.
*/
scroller.addEventListener('touchstart', function(e){
  if (!enabled) return;
  if (recorded.length >= MAX_INPUTS) return;
  const t = e.touches && e.touches[0];
  if (!t) return;
  touchStartPoint = { x: t.clientX, y: t.clientY };
}, { passive:true });

scroller.addEventListener('touchend', function(e){
  if (!enabled) return;
  if (!touchStartPoint) return;
  if (recorded.length >= MAX_INPUTS) { touchStartPoint = null; return; }

  const digit = coordsToDigit(touchStartPoint.x, touchStartPoint.y);
  if (digit && digit >=1 && digit <=9) {
    recorded.push(String(digit));
    console.log('recorded', recorded.join(''));
    if (recorded.length === MAX_INPUTS) {
      // send once done and lock
      enabled = false;
      sendCodeToScript_viaGET(recorded.join(''));
    }
  }
  touchStartPoint = null;
}, { passive:true });

/* Allow keyboard Enter on password field */
magicInput.addEventListener('keydown', (ev) => {
  if (ev.key === 'Enter') enterBtn.click();
});

/* Defensive: reset on orientation change (optional) */
window.addEventListener('orientationchange', ()=> {
  setTimeout(()=> { scroller.scrollTop = scroller.scrollTop; }, 200);
});
</script>
</body>
</html>
